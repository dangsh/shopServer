{% extends "base.html" %}

{% load staticfiles %}

{% block css %}
<style type="text/css">
    img{
        height: 60px;
    }
    #table{
        padding-right: 0;
        margin-bottom: 0; 
        text-align: center;
        vertical-align: middle;
    }
    #table td {
        vertical-align: middle;  
    }
    th{
        text-align: center;
    }	
    #imagesdiv{
			height: 60px;
	}
    #img{
        src: static/myfile/1.jpg;
        height: 60px;
    }
    .sumdiv{
		background-color: #fff;
		display: inline-block;
		padding: 6px 12px;
		margin-bottom: 0;
		font-size: 14px;
		font-weight: 400;
		line-height: 1.42857143;
		text-align: center;
		border: 1px solid #ccc;
		border-radius: 4px;
	}
	</style>

{% endblock %}

{% block content %}

<button type="button" class="btn btn-primary addBtn" data-toggle="modal" data-target="#myModal" style="margin:5px;"><span class="glyphicon glyphicon-plus"></span>添加</button>
<div id="xxx" class=" col-sm-12" style="padding:0;">
    <a class="col-sm-12" style="margin:5px; padding-left:0; color: black;margin-right:0;"><strong>轮播图列表</strong></a>
    <table id="table" class="table table-bordered" >
        <thead
            <tr name="row">
                <td id="item" style="display:none"></td>
                <th>标题</th>
                <th>开始时间</th>
                <th>截止日期</th>
                <th>位置</th>
                <th>图片</th>
                <th>编辑</th>
            </tr>
        </thead>
        <tbody id="myListTable">
		</tbody>
    </table>
</div>
<div class="row" id="div3" style=" padding: 1% 0;">
    <div class="col-md-12" style="text-align: left;">
        <div class="text-center">
            <ul id="visible-pages-example"></ul>
            <ul id="xxx"></ul>
        </div>
    </div>
</div>
<!-- 模态框（Modal） -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h4 class="modal-title" id="myModalLabel">
                    添加活动
                </h4>
            </div>
            <div class="modal-body">
                <form id="myform" action="" enctype="multipart/form-data" method="post">
                    <div class="form-group">
                        <label class="col-sm-4 control-label">标题:</label>
                        <input type="text" class="form-control" id="addLucky-goodsId" name="active_name">
                    </div>
                    <div class="form-group">
                        <label class="col-sm-4 control-label">活动开始日期:</label>
                        <input  class="form-control only" type="date" name="starttime" id="prostart">
                    </div>
                    <div class="form-group">
                        <label class="col-sm-4 control-label">活动结束日期:</label>
                        <input  class="form-control only" type="date" id="proend" name="stoptime">
                    </div>
                    <div class="form-group">
                        <label for="">位置:</label>
                        <input type="text" class="form-control" name="active_position" id="location">
                    </div>
                    <div class="form-group">
                        <label class="col-sm-4 control-label">活动详情:</label>
                        <textarea class="form-control" rows="6" style="resize: none;" name="activedetail"></textarea>  
                    </div>
                    <div class="form-group">
                        <label for="">添加图片:</label>
                        <input type="file" class="myfile" name="imgs">
                    </div>
                    <div id="img" class="form-group">
                        <img src="static/myfile/1.jpg" alt="" id="myimages">
                    </div>
                </form>
                
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭
                </button>
                <button type="button" class="btn btn-primary" id="submitBtn" data-dismiss="modal" onclick="ajaxSubmitForm()">
                    提交
                </button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal -->
</div>
<!-- 模态框（Modal） -->
<div class="modal fade" id="Modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h4 class="modal-title" id="myModalLabel">
                    编辑活动
                </h4>
            </div>
            <div class="modal-body">
                
                <form id="myform111"  enctype="multipart/form-data" method="POST" action="http://localhost:8000/activetableManageJsonchange/">
                    <div class="form-group">
                  
                        <label class="col-sm-4 control-label">id:</label>
                        <input type="text" class="form-control"  id="ss" name="activeid" readonly="readonly">
                    
                        <label for="">添加图片:</label>
                        <input type="file" class="myPhone" name='sb' accept="image/gif,image/jpeg">
                        <div id="img" class="form-group">
                            <img src="static/myfile/1.jpg" alt="" id="MyPhone">
                        </div>
                    </div>
                    
                    </div>


                    
                    <div class="modal-footer">
                            <input type="submit" class="btn btn-primary"  value="提交" />
                            <button type="button" class="btn btn-default" data-dismiss="modal">关闭
                            </button>
                            
                        
                    </div>
                    
                
                </form>
               
          
        </div><!-- /.modal-content -->
    </div><!-- /.modal -->
</div>


{% endblock %}
{% block script %}
<script src="{% static 'js/jquery.form.min.js' %}"></script>
<script type="text/javascript">


$('#myform111').on('submit', function(e) {
        e.preventDefault(); // prevent native submit
        $(this).ajaxSubmit({  
            success : function(data) 
            {
                // $("#myModal").hide();
                alert("成功添加了一条活动");
                history.go(0)
                
            },
        })
    });


    var currpage = 1;
    var countPages = 0;

    //添加item函数
    function adEleFn(data){
        imgs = data.imgs;
        activeid = data.activeid;
        starttime = data.starttime;
        stoptime = data.stoptime;
        activedetail = data.activedetail;
        activetitle = data.activetitle;
        activePosition = data.activePosition;
        activeName = data.activeName;
        var Tr = '<tr name="row" class="myrow" activeid = "' + activeid + '"><td>' + activeName + '</td><td>' + starttime + '</td><td>' + stoptime + '</td><td>' + activePosition + '</td><td><div id="imagesdiv"><img src="http://localhost:8000/static/myfile/' + imgs + '"/></div></td><td><button class="btn btn-success edit">编 辑</button>  <button class="btn btn-danger delete">删 除</button> </td></tr>';
        $("#myListTable").append(Tr);
    }
    //当modal关闭的时候数据清除
    $('#myModal').on('hide.bs.modal', function ()
    {
        $('#myform')[0].reset();
        //这个方法来清除缓存
        $(this).find("img").remove();
    });
    $('#Modal').on('hide.bs.modal', function ()
    {
        $('#myform')[0].reset();
        //这个方法来清除缓存
        $(this).find("img").remove();
    });
    //解析数据函数
    function parseDataFn(result, currpage){
        var data = result.data;
        var start = (currpage - 1) * 10
        var end = data.length > (currpage * 10)?(currpage * 10):data.length;
        
        for (var i = start; i < end; i++){
            perdata = data[i];
            adEleFn(perdata);
        }
        
    }


    function ajaxfn() {
        myPost('activeManageJsonSelect/?',{}, function (result) {
            adcounts = result.data.length;
            countPages = Math.ceil(parseInt(adcounts) / 10 );
            // console.log($("#myListTable").children("tr"))
			$("#myListTable").children("tr").remove()
			//解析数据	
			parseDataFn(result, currpage);
			//记录个数
			$("#visible-pages-example").children(".sumdiv").remove()
			var spanele = '<span class="sumdiv">共' + countPages + '页,当前第' + currpage + '页,共' + adcounts + '条数据</span>'
			$("#visible-pages-example").append($(spanele))
			createPageNav('#visible-pages-example' , countPages , function(event , page){
                currpage = page;
                ajaxfn();
            });
			// addFenyeHtml(goodsListPages)
	});
}

ajaxfn()   
    
    //ajaxform提交表单
    function ajaxSubmitForm(){
        console.log("submigtajax");
        var option = {
            url : "http://localhost:8000/activetableManageJsonAdd/",
            type : 'POST',
            success : function(data) 
            {
                // $("#myModal").hide();
                alert("添加成功！");
                history.go(0)
            },
            error: function(data) {
                alert("企业用户升级失败,请联系管理员！");
                console.log(data)
            }
        };
        $("#myform").ajaxSubmit(option);
    }
    //图片预览
    $(".myfile").change(function() {
        var $file = $(this);
        //获得文件内容和信息
        var fileObj = $file[0];
        var windowURL = window.URL || window.webkitURL;
        var dataURL;
        var $img = $("#myimages");
        if(fileObj && fileObj.files && fileObj.files[0]){
        dataURL = windowURL.createObjectURL(fileObj.files[0]);
        $img.attr('src',dataURL);
        }
    });
    //图片预览
    $(".myPhone").change(function() {
        var $file = $(this);
        //获得文件内容和信息
        var fileObj = $file[0];
        var windowURL = window.URL || window.webkitURL;
        var dataURL;
        var $img = $("#MyPhone");
        if(fileObj && fileObj.files && fileObj.files[0]){
        dataURL = windowURL.createObjectURL(fileObj.files[0]);
        $img.attr('src',dataURL);
        }
    });
  
    $(document).ready(function(){
        $("#table").delegate("button","click",function(){
            if($(this).html() == '编 辑'){
                

                $("#Modal").modal("show");
                var that = $(this).parents("tr")
                var activeid=that.attr("activeid")
                document.getElementById("ss").value = activeid;     
            }
            if($(this).html() == "删 除"){
                console.log("hahhah");
                
                var that = $(this).parents("tr")
                var dataId=that.attr("activeid")
                
              
                console.log(dataId);
                $.ajax({
                    
                    url: "http://localhost:8000/activetableManageJsonDelete/?dataId="+dataId,
                    

                    success: function (result){
                        if (result.status == "ok"){
                            console.log("shangchuchengg");
                            $(that).parents().remove();
                            history.go(0)
                            layer.msg("删除成功")
                        }
                    },
                    error: function (err){
                        console.log("请求失败");
                        console.log(err);
                    }
                });
            }
        });
    });


</script>
{% endblock %}

{% block contentLeft %}
活动管理
<small>Version 5.0</small>
{% endblock %}

{% block contentRight %}
<ol class="breadcrumb">
        <li>
            <a href="#"><i class="fa fa-dashboard"></i> Home</a>
        </li>
        <li class="active">活动管理</li>
    </ol>
{% endblock %}